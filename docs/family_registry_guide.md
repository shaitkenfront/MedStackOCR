# family_registry 運用手順

## 1. 事前準備
- 家族氏名辞書は LINEユーザーID ごとに DynamoDB へ保存される。
- 友だち追加（`follow`）時に、家族氏名登録フローを開始する。

## 2. 登録ルール
- すべての家族を 1名ずつ登録する（最低1名必須）。
- 1行に1名、同一人物の別表記はカンマ区切りで登録する。
  - 例: `山田 太郎, ヤマダ タロウ, 山田太朗`
- 別表記には次を優先して追加する。
  - スペース有無（`山田太郎` / `山田 太郎`）
  - 敬称付き（`山田 太郎様`）
  - カナ表記（`ヤマダ タロウ`）
  - よく出る誤読（例: `ヤマダ` -> `ヤマタ`）

## 3. 登録完了
- クイックリプライ `家族氏名の登録を終了` を押す。
- 登録完了前は通常のOCR処理には進まない。

## 4. 判定仕様（現行）
- 辞書一致（`canonical_name` または `aliases` 一致）: 通常判定
- 未登録だが同姓: `REVIEW_REQUIRED`
- 未登録かつ異姓: `REJECTED`

## 5. 日次運用フロー
1. LINE Developers の Webhook URL を AWS API Gateway（CDK出力 `LineWebhookUrl`）に設定
2. LINEで領収書画像を送信
3. `REVIEW_REQUIRED` / `REJECTED` の `family_member_name` と `decision.reasons` を確認
4. 正当な家族なら、再度名前（別表記）を送って辞書を更新
5. 他姓ノイズなら辞書追加せずそのまま `REJECTED` を維持

## 6. メンテナンスの目安
- 1名につき最低3〜5個の `aliases` を持つ
- 新しいOCRエンジン・帳票形式を追加したら aliases を再点検する
- 誤検出が続く場合は `aliases` 追加を優先し、抽出ロジック変更は最後に検討する
